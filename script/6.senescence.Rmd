
#Calculate score and 95% for each patient (9 Oct 2023)
```{r}
library(Seurat)
library(UCell)
library(ggplot2)
library(data.table)
library(tibble)
library(rstatix)
```


```{r}
gbm <- readRDS("output/seurat_gbm_qc")
```


```{r}
# create senescence score
signatures <- list(senescence = scan("data/lucy_senesence_genes.txt", character(), sep = ",", strip.white = TRUE))
```
```{r}
#set unknown 
#choose 1 if with unknown, 2 if w/o unknown
unknown <- unknowns[1]

#choose 1 if each, 2 if whole
#set whole vs each
run_each <- run_eachs[1]

#choose what to analyse

pick <- 3

merge <- merges[pick]

#run_each <- run_eachs[2]
if (run_each) {
  run <- runs[1]
} else {
  run <- runs[2]
}
```
```{r}
gbm <- NormalizeData(gbm)
gbm <- ScaleData(gbm, features = rownames(gbm))
```

#Ucell
```{r}
gbm <- AddModuleScore_UCell(gbm, features = signatures, name = NULL)
```

```{r}
gbm$donor_id <- as.factor(gbm$donor_id)
gbm$sen_label <- NA
gbm$cutoff_sen <- NA

p <- c()
for (i in levels(gbm$donor_id)) {
  q <- quantile(gbm@meta.data[gbm$radiation == "control" & gbm$donor_id == i, "senescence"], 0.95)

  gbm@meta.data[gbm$donor_id == i, "cutoff_sen"] <- q
  gbm@meta.data[gbm$radiation == "radiated" & gbm$donor_id == i & gbm$senescence > q, "sen_label"] <- "senescence" #assign senescence to radiated group
  gbm@meta.data[gbm$radiation == "control" & gbm$donor_id == i & gbm$senescence > q, "sen_label"] <- "senescence" #assign senescence to control group
}
gbm@meta.data[is.na(gbm$sen_label), "sen_label"] <- "not_senescence"
```
```{r}
senescene_score <- gbm@meta.data

senescene_score
```
```{r}
fwrite(gbm@meta.data, file = paste("output/senescence_score.csv",sep = "_"))
senescene_score <- fread(file = paste("output/senescence_score.csv",sep = "_"))
```

```{r}
ggplot(gbm@meta.data, aes(x = senescence, fill = sen_label)) +
  geom_histogram(position = "identity", bins = 40, alpha = 0.5)
```


```{r}
# visualization
library(ggplot2)

ggplot(gbm@meta.data, aes(x = senescence, fill = sen_label)) +
  geom_histogram(position = "identity", bins = 40, alpha = 0.5) +
  facet_wrap(~runs, ncol = 1)
```



```{r}
ggplot(gbm@meta.data, aes(x = senescence, fill = sen_label)) +
  geom_histogram(position = "identity", bins = 40, alpha = 0.5) +
  facet_wrap(~donor_id, ncol = 4) +
  scale_y_sqrt(breaks = c(0, 100, 500))
```

```{r}
library(dplyr)
library(ggplot2)

p <- ggplot(gbm@meta.data, aes(x = senescence, fill = radiation)) +
  geom_histogram(position = "identity", bins = 40, alpha = 0.5) +
  facet_wrap(~donor_id, ncol = 4) +
  scale_y_sqrt(breaks = c(0, 100, 500)) +
  geom_vline(mapping = aes(xintercept = cutoff_sen))

p
```
```{r}
# Add percentage of senescence state in radiated group

cols_to_convert <- c("donor_id", "radiation", "runs", "batch", "split", "donor_run", "donor_radiation", "sen_label")

gbm@meta.data[cols_to_convert] <- lapply(gbm@meta.data[cols_to_convert], factor)
```


```{r}
# calculate the

rad.sen.prop <- gbm@meta.data[gbm$radiation == "radiated", ] %>%
  group_by(donor_id, sen_label) %>% # Group by "Group" and "Category"
  summarize(
    Count = n(), # Count the number of occurrences of each category within each group
  ) %>%
  group_by(donor_id) %>%
  mutate(
    Proportion = Count / sum(Count),
    Percentage = ceiling(Proportion * 100)
  )




dat_text <- data.frame(
  label = paste0(as.character(rad.sen.prop[rad.sen.prop$sen_label == "senescence", "Percentage", drop = TRUE]), "%"),
  donor_id = as.factor(levels(rad.sen.prop$donor_id)),
  radiation = as.factor(rep("radiated", times = nrow(rad.sen.prop)))
)

p <- p + geom_text(
  data = dat_text,
  mapping = aes(x = 0.4, y = 350, label = label),
  size = 3
)
p <- p + labs(title = "Post-radiation senescence", subtitle = "vertical line are 95% percentile of control group for each donor", caption = "percentage of senescence in radiated condition are labeled in right-upper graph")

p <- p +
  xlab("Senescence score") +
  ylab("Count")

p
```

#Add annotation data
```{r}
senescene_score <- fread(file = paste("output/senescence_score.csv",sep = "_"))
anno.all.short <- fread(file = paste("output/annotation/annotation_short",merge,run,unknown,".csv",sep = "_"))
anno.all.short_edited <- column_to_rownames(anno.all.short,var = "rn")

anno.senesence <- cbind(anno.all.short_edited,senescene_score)

anno.senesence
```
#analysis
```{r}
#filter before analysis

# threshold.vec <- c(unknown = 0.5,
#                    confidence = 0.5,
#                    agreement = 0.25)

# no threshold
threshold.vec <- c(unknown = 1,
                   confidence = 0,
                   agreement = 0)

anno.senesence.filtered <- anno.senesence[anno.senesence$unknown <= threshold.vec["unknown"] &
                                            anno.senesence$confidence >= threshold.vec["confidence"] &
                                            anno.senesence$agreement >= threshold.vec["agreement"],]

anno.senesence.filtered
```
#intercellstate senescence heterogeneity
```{r}

#subset only control 
anno.senesence.filtered.radiation <- anno.senesence.filtered[anno.senesence.filtered$radiation == "control",]
anno.senesence.filtered.radiation
```

```{r}
#contingency table: Chi square
contingency_table <- table(anno.senesence.filtered.radiation$consensus, anno.senesence.filtered.radiation$sen_label)
contingency_table
```
```{r}
prop_table <- prop.table(contingency_table, margin = 1) #proportion row-wise
prop_table
```

```{r}
overall_chi_square <- chisq.test(contingency_table)
overall_chi_square
```


```{r}
pairwise_chi_square <- pairwise_prop_test(contingency_table)

prop_table
pairwise_chi_square
```
#intracellstate pre-post radiation senescence change
```{r}
cellstates <- unique(anno.senesence.filtered$consensus)
cellstates
```


```{r}
anno.senesence.filtered.cellstate <-  anno.senesence.filtered[anno.senesence.filtered$consensus == cellstates[4],]
anno.senesence.filtered.cellstate
```

```{r}
#contingency table: Chi square


contingency_table <- table(anno.senesence.filtered.cellstate$radiation, anno.senesence.filtered.cellstate$sen_label)
contingency_table
```
```{r}
prop_table <- prop.table(contingency_table, margin = 1) #proportion row-wise
prop_table
```

```{r}
overall_chi_square <- chisq.test(contingency_table)
overall_chi_square
```
