
#Calculate score and 95% for each patient (9 Oct 2023)
```{r}
library(Seurat)
library(UCell)
gbm <- readRDS("output/seurat_gbm_qc")

# create senescence score
signatures <- list(senescence = scan("data/lucy_senesence_genes.txt", character(), sep = ",", strip.white = TRUE))
```

```{r}
gbm <- NormalizeData(gbm)
gbm <- ScaleData(gbm, features = rownames(gbm))
```

#Ucell
```{r}
gbm <- AddModuleScore_UCell(gbm, features = signatures, name = NULL)
```

```{r}
gbm$donor_id <- as.factor(gbm$donor_id)
gbm$sen_label <- NA
gbm$cutoff_sen <- NA

p <- c()
for (i in levels(gbm$donor_id)) {
  q <- quantile(gbm@meta.data[gbm$radiation == "control" & gbm$donor_id == i, "senescence"], 0.95)

  gbm@meta.data[gbm$donor_id == i, "cutoff_sen"] <- q
  gbm@meta.data[gbm$radiation == "radiated" & gbm$donor_id == i & gbm$senescence > q, "sen_label"] <- "senescence"
}
gbm@meta.data[is.na(gbm$sen_label), "sen_label"] <- "not_senescence"
```
```{r}
gbm@meta.data
```

```{r}
ggplot(gbm@meta.data, aes(x = senescence, fill = sen_label)) +
  geom_histogram(position = "identity", bins = 40, alpha = 0.5)
```


```{r}
# visualization
library(ggplot2)

ggplot(gbm@meta.data, aes(x = senescence, fill = sen_label)) +
  geom_histogram(position = "identity", bins = 40, alpha = 0.5) +
  facet_wrap(~runs, ncol = 1)
```



```{r}
ggplot(gbm@meta.data, aes(x = senescence, fill = sen_label)) +
  geom_histogram(position = "identity", bins = 40, alpha = 0.5) +
  facet_wrap(~donor_id, ncol = 4) +
  scale_y_sqrt(breaks = c(0, 100, 500))
```

```{r}
library(dplyr)
library(ggplot2)

p <- ggplot(gbm@meta.data, aes(x = senescence, fill = radiation)) +
  geom_histogram(position = "identity", bins = 40, alpha = 0.5) +
  facet_wrap(~donor_id, ncol = 4) +
  scale_y_sqrt(breaks = c(0, 100, 500)) +
  geom_vline(mapping = aes(xintercept = cutoff_sen))

p
```
```{r}
# Add percentage of senescence state in radiated group

cols_to_convert <- c("donor_id", "radiation", "runs", "batch", "split", "donor_run", "donor_radiation", "sen_label")

gbm@meta.data[cols_to_convert] <- lapply(gbm@meta.data[cols_to_convert], factor)
```


```{r}
# calculate the

rad.sen.prop <- gbm@meta.data[gbm$radiation == "radiated", ] %>%
  group_by(donor_id, sen_label) %>% # Group by "Group" and "Category"
  summarize(
    Count = n(), # Count the number of occurrences of each category within each group
  ) %>%
  group_by(donor_id) %>%
  mutate(
    Proportion = Count / sum(Count),
    Percentage = ceiling(Proportion * 100)
  )




dat_text <- data.frame(
  label = paste0(as.character(rad.sen.prop[rad.sen.prop$sen_label == "senescence", "Percentage", drop = TRUE]), "%"),
  donor_id = as.factor(levels(rad.sen.prop$donor_id)),
  radiation = as.factor(rep("radiated", times = nrow(rad.sen.prop)))
)

p <- p + geom_text(
  data = dat_text,
  mapping = aes(x = 0.4, y = 350, label = label),
  size = 3
)
p <- p + labs(title = "Post-radiation senescence", subtitle = "vertical line are 95% percentile of control group for each donor", caption = "percentage of senescence in radiated condition are labeled in right-upper graph")

p <- p +
  xlab("Senescence score") +
  ylab("Count")

p
```

#Add annotation data
```{r}

```

